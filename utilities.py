
'''
directory handler

This file handles the directory issues
'''

import os
import os.path
import shutil
import subprocess

def get_data_directory(*specific_dir):
    '''
    help source code goes to data directory
    '''
    current_directory = os.path.dirname(os.path.realpath(__file__))

    data_directory = os.path.abspath(os.path.join(os.path.dirname( __file__ ), os.pardir, "data"))

    if specific_dir:
        data_directory = os.path.join(data_directory, *specific_dir)

    return data_directory

def extract_manifest(filename, is_malware=False):
    '''
    extract the manifest file from the apk

    returns the location of the manifest file
    '''
    output_name = os.path.basename(filename)[:-4] + "_manifest.xml"

    if is_malware:
        output_location = get_data_directory("malware_manifest")

    elif is_malware is None:
        output_location = "."
    
    else:
        output_location = get_data_directory("friendly_manifest")

    if os.path.exists(os.path.join(output_location, output_name)):
        # print("early returns")
        return os.path.join(output_location, output_name)

    try:
        temp = "temp_" + os.path.basename(filename)[:-4]
        subprocess.check_output(
            "bash apktool.sh d {} -f -o {}"\
            .format(filename, temp).split()
        )
        shutil.copy(os.path.join(temp,"AndroidManifest.xml"), os.path.join(output_location, output_name))
        shutil.rmtree(temp)

        return os.path.join(output_location, output_name)

    except subprocess.CalledProcessError as e:
        print(e)
        return None


if __name__ == "__main__":
    extract_manifest("/Users/jeromemao/Desktop/EECS600/project/data/friendly_apk/1000_androix.com.android.NightVisionCam.apk", is_malware=False)
    # out = get_data_directory("training_data", "API_22")
    # print os.path.exists(out)