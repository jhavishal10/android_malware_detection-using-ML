'''
this script extract API calls from an APK file
'''
import csv
import sys

from androguard.misc import AnalyzeAPK

def parse_results(repr_str):
    repr_str = repr_str.strip("<>")
    repr_str = repr_str[len("analysis.MethodClassAnalysis L"):]
    useful_part = repr_str.split("(")[0]

    return "/".join(useful_part.split(";->"))

def extract_singlefile(filename, dump=False, output=None):
    _, _, decompiled = AnalyzeAPK(filename)

    if dump:
        assert not (output is None), "Need an output location if you want to dump"

    used_func = []
    for i in decompiled.get_external_classes():
        temp_used_func = [parse_results(repr(func)) for func in i.get_methods()]
        used_func.extend(temp_used_func)

    if not dump:
        return used_func

    else:     
        with open(output, "w") as out:
            out.write("\n".join(used_func))
        return used_func


if __name__ == "__main__":
    extract_singlefile(sys.argv[1], sys.argv[2])